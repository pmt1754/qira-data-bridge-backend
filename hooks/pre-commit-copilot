#!/bin/bash
# Pre-commit hook with GitHub Copilot CLI protocol enforcement
# This hook runs automated protocol checks using GitHub Copilot before allowing commits
# Blocks commits with critical issues; allows commits with minor suggestions

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║          GitHub Copilot Pre-Commit Quality Gate              ║${NC}"
echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
echo ""

# Get the project root directory
PROJECT_ROOT=$(git rev-parse --show-toplevel)
REPORT_DIR="$PROJECT_ROOT/.git/hooks/reports"
REPORT_FILE="$REPORT_DIR/copilot-precommit-report.txt"

# Create report directory if it doesn't exist
mkdir -p "$REPORT_DIR"

# Initialize report file with header
cat > "$REPORT_FILE" << EOF
═══════════════════════════════════════════════════════════════
GitHub Copilot Pre-Commit Quality Report
═══════════════════════════════════════════════════════════════
Generated: $(date "+%Y-%m-%d %H:%M:%S")
Repository: $(basename "$PROJECT_ROOT")
Branch: $(git rev-parse --abbrev-ref HEAD)
═══════════════════════════════════════════════════════════════

EOF

# Check if GitHub Copilot CLI is available
if ! command -v gh &> /dev/null; then
    echo -e "${RED}✗ GitHub CLI (gh) not found${NC}"
    echo "  Please install: https://cli.github.com/"
    exit 1
fi

# Check if Copilot extension is available
if ! gh copilot --version &> /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ GitHub Copilot CLI not available${NC}"
    echo "  Install with: gh extension install github/gh-copilot"
    echo "  Skipping Copilot checks..."
    echo "" >> "$REPORT_FILE"
    echo "⚠ WARNING: GitHub Copilot CLI not available - checks skipped" >> "$REPORT_FILE"
    exit 0
fi

# Get list of staged files (only source code files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java|kt|kts|js|ts|tsx|jsx|py|go|rb|php|cs)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✓ No source code files staged${NC}"
    echo ""
    echo "No source code files to review" >> "$REPORT_FILE"
    exit 0
fi

echo -e "${CYAN}Files to review:${NC}"
echo "$STAGED_FILES" | while read -r file; do
    echo "  • $file"
done
echo ""

# Save staged files to report
echo "FILES UNDER REVIEW:" >> "$REPORT_FILE"
echo "-------------------------------------------------------------------" >> "$REPORT_FILE"
echo "$STAGED_FILES" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"

# Track blocking issues
HAS_BLOCKING_ISSUES=false
BLOCKING_REASONS=()

# Protocol paths
REVIEW_PROTOCOL="$PROJECT_ROOT/copilot/protocols/review.md"
SECURITY_PROTOCOL="$PROJECT_ROOT/copilot/protocols/security.md"
PERFORMANCE_PROTOCOL="$PROJECT_ROOT/copilot/protocols/performance.md"
TESTS_PROTOCOL="$PROJECT_ROOT/copilot/protocols/tests.md"
REFACTOR_PROTOCOL="$PROJECT_ROOT/copilot/protocols/refactor.md"

# Function to run Copilot review for a protocol
run_copilot_check() {
    local protocol_name=$1
    local protocol_file=$2
    local is_blocking=$3
    
    echo -e "${CYAN}▶ Running $protocol_name check...${NC}"
    
    # Add section header to report
    echo "" >> "$REPORT_FILE"
    echo "═══════════════════════════════════════════════════════════════" >> "$REPORT_FILE"
    echo "  $protocol_name CHECK" >> "$REPORT_FILE"
    echo "═══════════════════════════════════════════════════════════════" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    
    if [ ! -f "$protocol_file" ]; then
        echo -e "${YELLOW}  ⚠ Protocol file not found: $protocol_file${NC}"
        echo "⚠ Protocol file not found: $protocol_file" >> "$REPORT_FILE"
        echo "" >> "$REPORT_FILE"
        return 0
    fi
    
    # Read protocol content
    PROTOCOL_CONTENT=$(cat "$protocol_file")
    
    # Create temporary file with staged changes
    TEMP_DIFF=$(mktemp)
    git diff --cached > "$TEMP_DIFF"
    
    # Build prompt for Copilot
    PROMPT="Review the following code changes according to this protocol:

PROTOCOL:
$PROTOCOL_CONTENT

STAGED CHANGES:
$(cat "$TEMP_DIFF")

Analyze the changes and report:
1. Critical issues (architecture violations, security risks, missing tests, unsafe patterns)
2. Warnings (minor improvements, style suggestions)
3. Pass (if no issues)

Format your response as:
CRITICAL: [list critical issues or 'none']
WARNINGS: [list warnings or 'none']
STATUS: [BLOCK or PASS]"
    
    # Run Copilot review using explain command
    COPILOT_OUTPUT=$(echo "$PROMPT" | gh copilot explain 2>&1 || echo "ERROR: Copilot check failed")
    
    # Clean up temp file
    rm -f "$TEMP_DIFF"
    
    # Write output to report
    echo "$COPILOT_OUTPUT" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    
    # Check for critical issues in output
    if echo "$COPILOT_OUTPUT" | grep -qi "CRITICAL:" && ! echo "$COPILOT_OUTPUT" | grep -qi "CRITICAL: none"; then
        if [ "$is_blocking" = "true" ]; then
            HAS_BLOCKING_ISSUES=true
            BLOCKING_REASONS+=("$protocol_name: Critical issues detected")
            echo -e "${RED}  ✗ Critical issues found${NC}"
        else
            echo -e "${YELLOW}  ⚠ Issues found (non-blocking)${NC}"
        fi
    elif echo "$COPILOT_OUTPUT" | grep -qi "STATUS: BLOCK"; then
        if [ "$is_blocking" = "true" ]; then
            HAS_BLOCKING_ISSUES=true
            BLOCKING_REASONS+=("$protocol_name: Review blocked")
            echo -e "${RED}  ✗ Review blocked${NC}"
        else
            echo -e "${YELLOW}  ⚠ Issues found (non-blocking)${NC}"
        fi
    else
        echo -e "${GREEN}  ✓ Check passed${NC}"
    fi
}

# Step 1: Architecture & Code Review
run_copilot_check "Architecture & Code Review" "$REVIEW_PROTOCOL" "true"

# Step 2: Security Review
run_copilot_check "Security" "$SECURITY_PROTOCOL" "true"

# Step 3: Performance Review
run_copilot_check "Performance" "$PERFORMANCE_PROTOCOL" "true"

# Step 4: Testing Review
run_copilot_check "Testing" "$TESTS_PROTOCOL" "true"

# Step 5: Refactoring Suggestions (non-blocking)
run_copilot_check "Refactoring" "$REFACTOR_PROTOCOL" "false"

# Add footer to report
echo "" >> "$REPORT_FILE"
echo "═══════════════════════════════════════════════════════════════" >> "$REPORT_FILE"
echo "END OF REPORT" >> "$REPORT_FILE"
echo "═══════════════════════════════════════════════════════════════" >> "$REPORT_FILE"

echo ""
echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"

# Final decision
if [ "$HAS_BLOCKING_ISSUES" = true ]; then
    echo -e "${RED}║                    ✗ COMMIT BLOCKED                           ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${RED}Critical issues detected:${NC}"
    for reason in "${BLOCKING_REASONS[@]}"; do
        echo -e "${RED}  • $reason${NC}"
    done
    echo ""
    echo -e "${YELLOW}Review the detailed report:${NC}"
    echo -e "  ${CYAN}$REPORT_FILE${NC}"
    echo ""
    echo -e "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}"
    echo -e "  ${CYAN}git commit --no-verify${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}║                    ✓ ALL CHECKS PASSED                        ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${GREEN}No critical issues detected. Safe to commit!${NC}"
    echo ""
    echo -e "${CYAN}Detailed report saved to:${NC}"
    echo -e "  ${CYAN}$REPORT_FILE${NC}"
    echo ""
    exit 0
fi
